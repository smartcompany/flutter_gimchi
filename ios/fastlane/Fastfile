# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

# Uncomment the line if you want fastlane to automatically update itself
# update_fastlane

app_store_connect_api_key(
  key_id: "7FN57R567Z",
  issuer_id: "69a6de88-7946-47e3-e053-5b8c7c11a4d1",
  key_filepath: "/Users/smart/Projects/FlutterGimchi/fastlaneAuthKeys/AuthKey_7FN57R567Z.p8"
)

default_platform(:ios)

platform :ios do
  desc "Push a new release build to the App Store"
  lane :release do
    
    cocoapods(
      clean_install: true,
      repo_update: false,
      silent: false
    )

    increment_build_number(xcodeproj: "Runner.xcodeproj")
    
    # Clean build folder before building
    clean_build_artifacts
    
    # Build app with dSYM generation
    # Note: iOS uses "app-store" for export_method, but export_options.method can be "app-store-connect"
    build_app(
      workspace: "Runner.xcworkspace", 
      scheme: "Runner",
      export_method: "app-store",
      clean: true,
      export_options: {
        method: "app-store",
        uploadBitcode: false,
        uploadSymbols: true,
        compileBitcode: false,
        signingStyle: "automatic",
        teamID: "NTCK5U8AWD"
      }
    )
    
    # Upload dSYM to Crashlytics
    upload_symbols_to_crashlytics(
      gsp_path: "Runner/GoogleService-Info.plist"
    )
    
    # Upload to App Store
    # Note: If you see 500 error after "UPLOAD SUCCEEDED", the upload actually succeeded
    # The error is from Apple's metrics logging service, not the actual upload
    begin
      upload_to_app_store(
        skip_metadata: true,
        skip_screenshots: true,
        skip_app_version_update: true,
        precheck_include_in_app_purchases: false,
        force: true,
        submission_information: {
          export_compliance: {
            uses_non_exempt_encryption: false
          }
        }
      )
    rescue => ex
      # Check if upload actually succeeded despite the error
      if ex.message.include?("UPLOAD SUCCEEDED") || ex.message.include?("Delivery UUID")
        UI.success("Upload succeeded! The error is from Apple's metrics service and can be ignored.")
        UI.message("Please check App Store Connect to confirm the build was uploaded.")
      else
        raise ex
      end
    end
  end
end
